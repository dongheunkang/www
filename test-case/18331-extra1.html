<html>
<head>
<script src="shaka-player.compiled.js"></script>
<script>
function loadPlayer() {
  document.getElementById('ver').innerHTML = "shaka-player:" + shaka.Player.version + "";

  // Install built-in polyfills to patch browser incompatibilities.
  shaka.polyfill.installAll();

  // Check to see if the browser supports the basic APIs Shaka needs.
  if (!shaka.Player.isBrowserSupported()) {
    // This browser does not have the minimum set of APIs we need.
    console.error('Browser not supported!');
    return;
  }

  // Create a Player instance.
  var video = document.getElementById('player');
  var player = new shaka.Player(video);

  // Attach player to the window to make it easy to access in the JS console.
  window.player = player;

  // Listen for error events.
  player.addEventListener('error', onErrorEvent);

  var uri = "./video/ocean-dash/index.mpd";
  // Try to load a manifest.
  // This is an asynchronous process.
  player.load(uri).then(function() {
    // This runs if the asynchronous load is successful.
    console.log('The video has now been loaded!');
  }).catch(onError);  // onError is executed if the asynchronous load fails.
}

function onErrorEvent(event) {
  // Extract the shaka.util.Error object from the event.
  onError(event.detail);
}

function onError(error) {
  // Log the error.
  console.error('Error code', error.code, 'object', error);
  trace.log('Error code', error.code, 'object', error);
}

function unloadPlayer(callback) {
  window.player.destroy().then(function() {
    if (callback) callback();
  }).catch(function(error) {
    console.error("destroy error" + error);
  });
}

</script>
</head>
<body style="background-color:white;">
<h1>Test MSE Player</h1>
<h3 id="ver"></h3>
<div id="video" style="position:absolute;left:500;width:640;height:266;">
<video loop id="player" width='100%' height='100%'>
</div>
<div id="output" class="output">
  <pre style="font-size:22px;" id="info"></pre>
  <pre style="font-size:22px;" id="log"></pre>
</div>
<script>
/*
var trace = {
  log: function() {
    var line = Array.prototype.slice.call(arguments).map(function(argument) {
      return typeof argument === 'string' ? argument : JSON.stringify(argument);
    }).join(' ');

    document.querySelector('#log').textContent += line + '\n';
  },

  clearLog: function() {
    document.querySelector('#log').textContent = '';
  },
};
*/
var trace = {
  log: function() {
    var line = Array.prototype.slice.call(arguments).map(function(argument) {
      return typeof argument === 'string' ? argument : JSON.stringify(argument);
    }).join(' ');

    var total_lines = (document.querySelector('#log').textContent.match(/\n/g) || '').length + 1;
    if (total_lines > 20)
      document.querySelector('#log').textContent = '';

    document.querySelector('#log').textContent = line + '\n' + document.querySelector('#log').textContent;
  },

  clearLog: function() {
    document.querySelector('#log').textContent = '';
  },
};

function timeupdate_handler() {
  document.querySelector('#info').textContent = "currentTime: " + document.querySelector('#player').currentTime;
}

function event_handler(event) {
  trace.log(event.type);
}

function addEventsHandler() {
  var mediaevent_ = ["loadstart","suspend","abort","emptied","stalled",
      "loadedmetadata","loadeddata","canplay","canplaythrough",
      "playing","waiting","seeking","seeked","ended","durationchange",
      "play","pause","ratechange","volumechange"];
  var i = 0;
  do {
    var keyname = mediaevent_[i++];
    document.querySelector('#player').addEventListener(keyname, event_handler, false);
  } while (i < mediaevent_.length);
}

function load() {
  document.querySelector('#player').setAttribute("autoplay", "");
  document.querySelector('#player').setAttribute("controls", "");
  loadPlayer();
  document.querySelector('#player').addEventListener("timeupdate", timeupdate_handler);
  addEventsHandler();
  trace.log("load");
}

function test() {
  load();
}
test();
</script>
</body>
</html>
