<html>
<body style="background-color:white;padding:10px;">
<h3>WebMedia Test EME AV1 capabilities</h3>
<div id="output" class="output">
  <pre style="font-size:16px;" id="log"></pre>
</div>
 
<script>
var trace = {
  log: function() {
    var line = Array.prototype.slice.call(arguments).map(function(argument) {
      return typeof argument === 'string' ? argument : JSON.stringify(argument);
    }).join(' ');

    document.querySelector('#log').textContent += line + '\n';
  },

  clearLog: function() {
    document.querySelector('#log').textContent = '';
  },
};

var capabilities_true = [
  ['video/mp4; codecs="av01.0.31M.10.0.111.09.16.09.0"', 'com.widevine.alpha'],
  ['video/mp4; codecs="av01.0.31M.10.0.111.09.16.09.0"', 'com.microsoft.playready'],
];

async function query() {
  fail_count = 0;
  trace.log('--------------------------------------------------------------');
  trace.log('Support AV1 (expected True)');
  trace.log('--------------------------------------------------------------');
  for (var data of capabilities_true) {
    try {
      mksa = await navigator.requestMediaKeySystemAccess(data[1],
        [{ initDataTypes: ['cenc'], videoCapabilities: [{ contentType: data[0] }]}]
      );
      if (mksa) {
        trace.log("navigator.requestMediaKeySystemAccess(keysystem, '" + data[0] + "')");
        trace.log("=> Supported " + data[1] + "(videoCapabilities:" +JSON.stringify(mksa.getConfiguration().videoCapabilities) + ")");
      }
    } catch(error) {
      trace.log("navigator.requestMediaKeySystemAccess(keysystem, '" + data + "')");
      trace.log("=> Not Suppored com.widevine.alpha ("+error+")");
      fail_count += 1;
    }
  }

  trace.log('--------------------------------------------------------------');

  return !(fail_count > 0);
}

var result = false;
query().then(function(a) { console.log("result=", a);result = a; });

function test() {
  return result;
}
</script>
</body>
</html>

